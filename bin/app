#!/bin/bash
#set -x

## We include the global environment.
## Make your changes in the bin/.env file
source "$(cd $(dirname $(cd $(dirname $0);pwd -P));pwd -P)/bin/.env"

## Change CWD to the Apps main root directory
cd $APP_HOME

## Display Usage Information 
usage() {
	cat << EOF
usage: $0 command [command options]

This is the usage description of your app.

Available Commands:
   start          Start the app
   stop           Stop the app
   install        Initially installs and configures the environment of the app
EOF
}

COMMAND="$1"
shift

if [[ -z $COMMAND ]]; then
	usage
	exit 1
fi

## First we try to let our app handle the command
$ENV node $APP_LIB $COMMAND "$@"
RET="$?"

## If there is no such command, we try to find some known places in our app.
if [[ $RET -eq 2 ]]; then

	if [[ -x "$APP_PLATFORMBIN/$COMMAND" ]] && [[ -f "$APP_PLATFORMBIN/$COMMAND" ]]; then
		$ENV $APP_PLATFORMBIN/$COMMAND "$@"
		exit $?

	elif [[ -x "$APP_NPMHOME/bin/$COMMAND" ]] && [[ -f "$APP_NPMHOME/bin/$COMMAND" ]]; then
		$ENV $APP_NPMHOME/bin/$COMMAND "$@"
		exit $?
	fi

fi

echo "RETURN $RET"
if [[ $RET -gt 0 ]]; then
	usage
fi

exit $RET
