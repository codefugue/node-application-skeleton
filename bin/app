#!/bin/bash
#set -x

APP_HOME="$(cd $(dirname $(cd $(dirname $0);pwd -P));pwd -P)"
cd $APP_HOME;

APP_BIN="$APP_HOME/bin"
APP_CONF="$APP_HOME/etc"
APP_TMP="$APP_HOME/tmp"
APP_PLATFORM="$(uname -s)"
APP_REALBIN="$APP_BIN/${APP_PLATFORM}-${HOSTTYPE}"
APP_NODEMODULESBIN="$APP_HOME/node_modules/.bin"
APP_PATH="$APP_BIN:$APP_NODEMODULESBIN:$PATH"
APP_ENV="development"
APP_MAIN="$APP_HOME/index.js"
APP_INSTALL="$APP_HOME/lib/install.js"

## We change the PATH to the one defined inside this script. Add all PATHs you need
## We also add a APP_HOME ENV and the more widely use NODE_ENV (expressjs, etc.)
ENV="/usr/bin/env PATH=$APP_PATH APP_HOME=$APP_HOME APP_CONF=$APP_CONF NODE_ENV=$APP_ENV npm_config_prefix=$APP_HOME npm_config_globalconfig=$APP_CONF/npmrc"

## Create symlinks from ./bin/ to the correct binaries of your app
## Once you called the script, all binaries of the correct platform
## and bitness are callable in APP_BIN
#if [[ -d "$APP_BIN" && -r "$APP_BIN" ]]; then
#	cd $APP_BIN;
#	if [[ -d "$APP_REALBIN"  && -r "$APP_REALBIN" && "$(ls -A $APP_REALBIN)" ]];then
#		ln -sf $APP_REALBIN/* ./;
#	fi
#  if [[ -d "$APP_NODEMODULESBIN"  && -r "$APP_NODEMODULESBIN" && "$(ls -A $APP_NODEMODULESBIN)" ]];then
#    ln -sf $APP_NODEMODULESBIN/* ./; 
#  fi
#  cd $APP_HOME
#fi;

## Display Usage Information 
usage() {
	cat << EOF
usage: $0 command [options]

This is the usage description of your app.

OPTIONS:
   -h      Show this message
   -f      Set the FOO Env
   -v      Verbose
EOF
}

## We suppose the first argument is a command 
## identifier like 'start', 'stop', ...
COMMAND="$1"
shift

#FOO=
#VERBOSE=
#while getopts “hf:v” OPTION
#do
#	case $OPTION in
#		h)
#			usage
#			exit 1
#			;;
#		f)
#			FOO=$OPTARG
#			;;
#		v)
#			VERBOSE=1
#			;;
#		?)
#			usage
#			exit
#			;;
#	esac
#done

## Check for all your mandatory arguments here.
## At least a command has to be set so we check that here.
if [[ -z $COMMAND ]] #|| [[ -z $TEST ]] || [[ -z $SERVER ]] || [[ -z $PASSWD ]]
then
	usage
	exit 1
fi

## Decide what to do depending on the command:

## 'install' command parses all config files found in 
## APP_CONF with mustache and passing all ENV vars
## and arguments to them.
if [[ $COMMAND == "install" ]]; then
	$ENV node $APP_INSTALL
	exit 0

## 'usage' shows usage information
elif [[ $COMMAND == "usage" ]] || [[ $COMMAND == "help" ]]; then
	usage
	exit 1

## Just an example call to APP_MAIN
elif [[ $COMMAND == "start" ]]; then
	$ENV node $APP_MAIN "$@"
	if [[ $? -gt 0 ]]; then
		usage
		exit 1
	else
		exit 0
	fi
else
	if [[ -x "$APP_BIN/$COMMAND" ]]; then
		$ENV $APP_BIN/$COMMAND "$@"
		exit $?
	elif [[ -x "$APP_REALBIN/$COMMAND" ]]; then
		$ENV $APP_REALBIN/$COMMAND "$@"
		exit $?
	elif [[ -x "$APP_NODEMODULESBIN/$COMMAND" ]]; then
		$ENV $APP_NODEMODULESBIN/$COMMAND "$@"
		exit $?
	else
		usage
		exit 1
	fi
fi

exit 1
