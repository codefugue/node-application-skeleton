#!/bin/bash
#set -x

## We include the global environment.
## Make your changes in the bin/.env file
source "$(cd $(dirname $(cd $(dirname $0);pwd -P));pwd -P)/bin/.env"

## Change CWD to the Apps main root directory
cd $APP_MAIN

## Display Usage Information 
usage() {
	cat << EOF
usage: $0 command [command options]

This is the usage description of your app.

Available Commands:
   start          Start the app
   stop           Stop the app
   install        Initially installs and configures the environment of the app
   usage|help     Show this messsage
EOF
}

COMMAND="$1"
shift

if [[ -z $COMMAND ]]; then
	usage
	exit 1
fi

## Install command
if [[ $COMMAND == "install" ]]; then
	$ENV node $APP_INSTALL "$@"
	exit 0

## 'usage' shows usage information
elif [[ $COMMAND == "usage" ]] || [[ $COMMAND == "help" ]]; then
	usage
	exit 1

## Just an example call to APP_MAIN
elif [[ $COMMAND == "start" ]]; then
	$ENV node $APP_MAIN "$@"
	if [[ $? -gt 0 ]]; then
		usage
		exit 1
	else
		exit 0
	fi

## Otherwise we search some common known directories within $APP_HOME
else
	if [[ -x "$APP_PLATFORMBIN/$COMMAND" ]] && [[ -f "$APP_PLATFORMBIN/$COMMAND" ]]; then
		$ENV $APP_PLATFORMBIN/$COMMAND "$@"
		exit $?

	elif [[ -x "$APP_NPMHOME/bin/$COMMAND" ]] && [[ -f "$APP_NPMHOME/bin/$COMMAND" ]]; then
		$ENV $APP_NPMHOME/bin/$COMMAND "$@"
		exit $?

	else
		usage
		exit 1
	fi

fi

usage
exit 1
